<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Cek Blob Walrus dari Public Key Soundness</title>
</head>
<body>
  <h2>Cek Blob Walrus dari Public Key Soundness</h2>
  <input id="pubkey" type="text" placeholder="Paste Public Key Soundness di sini" style="width: 400px;">
  <button onclick="cekBlob()">Cek</button>
  <pre id="result"></pre>

<script type="module">
import { blake2b } from "https://cdn.jsdelivr.net/npm/@noble/hashes@1.3.2/blake2b.js";

async function publicKeyToSuiAddress(pubKeyB64) {
    try {
        const rawKey = Uint8Array.from(atob(pubKeyB64), c => c.charCodeAt(0));
        if (rawKey.length !== 32) {
            throw new Error("Public key harus 32 byte setelah Base64 decode");
        }
        // Prefix 0x00 untuk Ed25519
        const prefixed = new Uint8Array(1 + rawKey.length);
        prefixed[0] = 0x00;
        prefixed.set(rawKey, 1);
        const hash = blake2b(prefixed, { dkLen: 32 });
        return "0x" + Array.from(hash).map(b => b.toString(16).padStart(2, "0")).join("");
    } catch (e) {
        throw new Error("Public key tidak valid: " + e.message);
    }
}

async function cekBlob() {
    const pubKey = document.getElementById("pubkey").value.trim();
    const output = document.getElementById("result");
    output.textContent = "Mengonversi public key menjadi alamat Sui...\n";
    try {
        const suiAddress = await publicKeyToSuiAddress(pubKey);
        output.textContent += `Alamat Sui: ${suiAddress}\n\nMengambil blob history...\n`;

        const apiKey = "39Ki3kPJFMJ9eukD5yrpWJkNWX7Qm1"; // ganti dengan API key Blockberry
        const url = `https://api.blockberry.one/walrus-mainnet/v1/blobs/accounts/${suiAddress}`;
        const res = await fetch(url, {
            headers: {
                "accept": "application/json",
                "x-api-key": apiKey
            }
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        if (!data || data.length === 0) {
            output.textContent += "Tidak ada blob ditemukan.";
            return;
        }

        let resultText = "Daftar Blob:\n";
        for (const blob of data) {
            resultText += `- blobIdBase64: ${blob.blobIdBase64}\n  createdAt: ${blob.createdAt}\n\n`;
        }
        output.textContent = resultText;
    } catch (err) {
        output.textContent += "Error: " + err.message;
    }
}
</script>
</body>
</html>
