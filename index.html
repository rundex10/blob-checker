<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Cek Blob Walrus</title>
<script src="https://cdn.jsdelivr.net/npm/blakejs@1.2.1/blake2b.min.js"></script>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    input { width: 450px; padding: 8px; }
    button { padding: 8px 14px; margin-left: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #333; color: white; }
    #status { margin-top: 15px; font-weight: bold; }
</style>
</head>
<body>
<h2>Cek Blob Walrus dari Public Key atau Address</h2>
<p>Masukkan <b>public key Base64</b> atau <b>address Sui</b>.</p>
<input type="text" id="inputValue" placeholder="Public key atau address Sui">
<button onclick="cekBlob()">Cek</button>
<div id="status"></div>

<table id="resultTable" style="display:none;">
    <thead>
        <tr>
            <th>Blob list</th>
            <th>Waktu Dibuat</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<script>
async function cekBlob() {
    let val = document.getElementById('inputValue').value.trim();
    if (!val) {
        alert("Masukkan public key atau address Sui!");
        return;
    }

    document.getElementById('status').innerText = "⏳ Memproses...";
    document.getElementById('resultTable').style.display = "none";

    let address = val;

    // Jika bukan address (0x...), berarti public key → konversi
    if (!val.startsWith("0x")) {
        try {
            address = publicKeyToSuiAddress(val);
            document.getElementById('status').innerText = "✅ Public key dikonversi ke address: " + address;
        } catch (e) {
            document.getElementById('status').innerText = "❌ Public key tidak valid: " + e.message;
            return;
        }
    } else {
        document.getElementById('status').innerText = "✅ Menggunakan address: " + address;
    }

    let apiKey = "39Ki3kPJFMJ9eukD5yrpWJkNWX7Qm1";
    let url = `https://api.blockberry.one/walrus-mainnet/v1/blobs/accounts/${address}?page=0&size=20&orderBy=DESC&sortBy=TIMESTAMP`;

    try {
        let res = await fetch(url, {
            headers: {
                "accept": "*/*",
                "x-api-key": apiKey
            }
        });
        if (!res.ok) {
            document.getElementById('status').innerText = `❌ HTTP ${res.status}: ${res.statusText}`;
            return;
        }
        let data = await res.json();
        tampilkanData(data.content);
    } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = "❌ Gagal mengambil data!";
    }
}

function tampilkanData(content) {
    let tbody = document.querySelector("#resultTable tbody");
    tbody.innerHTML = "";
    if (!content || content.length === 0) {
        tbody.innerHTML = "<tr><td colspan='2'>Tidak ada blob ditemukan</td></tr>";
    } else {
        content.forEach(item => {
            let tr = document.createElement("tr");

            let tdBlob = document.createElement("td");
            tdBlob.innerText = item.blobIdBase64;

            let tdTime = document.createElement("td");
            let date = new Date(item.timestamp / 1_000_000).toLocaleString();
            tdTime.innerText = date;

            tr.appendChild(tdBlob);
            tr.appendChild(tdTime);
            tbody.appendChild(tr);
        });
    }
    document.getElementById('resultTable').style.display = "table";
}

function publicKeyToSuiAddress(base64Key) {
    // Tambahkan padding jika hilang
    while (base64Key.length % 4 !== 0) {
        base64Key += "=";
    }

    // Decode Base64
    let publicKeyBytes;
    try {
        publicKeyBytes = Uint8Array.from(atob(base64Key), c => c.charCodeAt(0));
    } catch {
        throw new Error("Base64 tidak valid");
    }

    if (publicKeyBytes.length !== 32) {
        throw new Error("Panjang public key bukan 32 byte (bukan ed25519)");
    }

    // Prefix 0x00 untuk ed25519
    const prefixed = new Uint8Array(publicKeyBytes.length + 1);
    prefixed[0] = 0x00;
    prefixed.set(publicKeyBytes, 1);

    // Hash Blake2b-256
    const hash = blake2b(prefixed, null, 32);
    return "0x" + Array.from(hash).map(b => b.toString(16).padStart(2, '0')).join('');
}
</script>
</body>
</html>
